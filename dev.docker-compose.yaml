version: "3.9"
services:
  fluentd:
    image: fluent/fluentd:v1.16-1
    env_file:
      - .env
    volumes:
      - ./fluentd:/fluentd/etc
      - ./logs:/fluentd/log
    ports: 
      - ${FLUENTD_PORT}:24224
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "24224"]
      interval: 1s
      timeout: 1s
      retries: 30

  backend:
    build:
      context: backend
      dockerfile: Dockerfile
    env_file:
      - .env
    ports:
      - ${BACKEND_PORT}:5000
    volumes:
      - ./backend:/app
    environment:
      - DEV_MODE=1
    depends_on:
      fluentd:
        condition: service_healthy
    logging:
      driver: fluentd
      options:
        fluentd-address: localhost:${FLUENTD_PORT}
        tag: backend

  frontend:
    build:
      context: frontend
      dockerfile: dev.Dockerfile
    env_file:
      - .env
    ports:
      - ${FRONTEND_PORT}:3000
    volumes:
      - /app/node_modules
      - ./frontend:/app
    environment:
      - WATCHPACK_POLLING=true
    stdin_open: true
    depends_on:
      fluentd:
        condition: service_healthy
    logging:
      driver: fluentd
      options:
        fluentd-address: localhost:${FLUENTD_PORT}
        tag: frontend
